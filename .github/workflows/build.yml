name: Build FFmpeg

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-x264:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            git

      - name: Build x264
        run: |
          chmod +x scripts/build-x264-linux.sh
          ./scripts/build-x264-linux.sh

      - name: Upload x264 artifact
        uses: actions/upload-artifact@v4
        with:
          name: x264-build
          path: ffmpeg-build/
          retention-days: 1

  build-opus:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            git

      - name: Build libopus
        run: |
          chmod +x scripts/build-opus-linux.sh
          ./scripts/build-opus-linux.sh

      - name: Upload libopus artifact
        uses: actions/upload-artifact@v4
        with:
          name: opus-build
          path: ffmpeg-build/
          retention-days: 1

  build-aom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            git

      - name: Build libaom
        run: |
          chmod +x scripts/build-aom-linux.sh
          ./scripts/build-aom-linux.sh

      - name: Upload libaom artifact
        uses: actions/upload-artifact@v4
        with:
          name: aom-build
          path: ffmpeg-build/
          retention-days: 1

  build-vpx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            yasm \
            git

      - name: Build libvpx
        run: |
          chmod +x scripts/build-vpx-linux.sh
          ./scripts/build-vpx-linux.sh

      - name: Upload libvpx artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpx-build
          path: ffmpeg-build/
          retention-days: 1

  build-ffmpeg:
    runs-on: ubuntu-latest
    needs: [build-x264, build-opus, build-aom, build-vpx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            yasm \
            pkg-config \
            git \
            libssl-dev \
            zlib1g-dev

      - name: Download x264 build
        uses: actions/download-artifact@v4
        with:
          name: x264-build
          path: ffmpeg-build/

      - name: Download libopus build
        uses: actions/download-artifact@v4
        with:
          name: opus-build
          path: ffmpeg-build/

      - name: Download libaom build
        uses: actions/download-artifact@v4
        with:
          name: aom-build
          path: ffmpeg-build/

      - name: Download libvpx build
        uses: actions/download-artifact@v4
        with:
          name: vpx-build
          path: ffmpeg-build/

      - name: Verify downloaded libraries
        run: |
          echo "=== Downloaded library files ==="
          ls -lah ffmpeg-build/
          echo "=== Library directory ==="
          ls -lah ffmpeg-build/lib/ || true
          echo "=== Include directory ==="
          ls -lah ffmpeg-build/include/ || true
          echo "=== pkg-config files ==="
          ls -lah ffmpeg-build/lib/pkgconfig/ || true

      - name: Build FFmpeg
        run: |
          chmod +x scripts/build-linux.sh
          ./scripts/build-linux.sh

      - name: Test binary
        run: |
          ./ffmpeg-build/bin/ffmpeg -version
          ./ffmpeg-build/bin/ffprobe -version

      - name: Upload FFmpeg artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: |
            ffmpeg-build/bin/ffmpeg
            ffmpeg-build/bin/ffprobe

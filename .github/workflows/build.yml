name: Build FFmpeg

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-x264:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            git

      - name: Build x264
        run: |
          echo "Building x264 from source..."
          chmod +x scripts/build-x264-linux.sh
          ./scripts/build-x264-linux.sh

      - name: Upload x264 artifact
        uses: actions/upload-artifact@v4
        with:
          name: x264-build
          path: ffmpeg-build/
          retention-days: 1

  build-opus:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            git

      - name: Build libopus
        run: |
          echo "Building libopus from source..."
          chmod +x scripts/build-opus-linux.sh
          ./scripts/build-opus-linux.sh

      - name: Upload libopus artifact
        uses: actions/upload-artifact@v4
        with:
          name: opus-build
          path: ffmpeg-build/
          retention-days: 1

  build-aom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            git

      - name: Build libaom
        run: |
          echo "Building libaom from source..."
          chmod +x scripts/build-aom-linux.sh
          ./scripts/build-aom-linux.sh

      - name: Upload libaom artifact
        uses: actions/upload-artifact@v4
        with:
          name: aom-build
          path: ffmpeg-build/
          retention-days: 1

  build-vpx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            yasm \
            git

      - name: Build libvpx
        run: |
          echo "Building libvpx from source..."
          chmod +x scripts/build-vpx-linux.sh
          ./scripts/build-vpx-linux.sh

      - name: Upload libvpx artifact
        uses: actions/upload-artifact@v4
        with:
          name: vpx-build
          path: ffmpeg-build/
          retention-days: 1

  build-svtav1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            git

      - name: Build SVT-AV1
        run: |
          echo "Building SVT-AV1 from source..."
          chmod +x scripts/build-svtav1-linux.sh
          ./scripts/build-svtav1-linux.sh

      - name: Upload SVT-AV1 artifact
        uses: actions/upload-artifact@v4
        with:
          name: svtav1-build
          path: ffmpeg-build/
          retention-days: 1

  build-fdk-aac:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            git

      - name: Build libfdk-aac
        run: |
          echo "Building libfdk-aac from source..."
          chmod +x scripts/build-fdk-aac-linux.sh
          ./scripts/build-fdk-aac-linux.sh

      - name: Upload libfdk-aac artifact
        uses: actions/upload-artifact@v4
        with:
          name: fdk-aac-build
          path: ffmpeg-build/
          retention-days: 1

  build-x265:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            libnuma-dev \
            wget \
            git

      - name: Build libx265
        run: |
          echo "Building libx265 from source..."
          chmod +x scripts/build-x265-linux.sh
          ./scripts/build-x265-linux.sh

      - name: Upload libx265 artifact
        uses: actions/upload-artifact@v4
        with:
          name: x265-build
          path: ffmpeg-build/
          retention-days: 1

  build-ffmpeg:
    runs-on: ubuntu-latest
    needs: [build-x264, build-opus, build-aom, build-vpx, build-svtav1, build-fdk-aac, build-x265]
    permissions:
      actions: write  # Required to delete artifacts on failure
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            yasm \
            pkg-config \
            git \
            libssl-dev \
            zlib1g-dev \
            libnuma-dev

      - name: Download x264 build
        uses: actions/download-artifact@v4
        with:
          name: x264-build
          path: ffmpeg-build/

      - name: Download libopus build
        uses: actions/download-artifact@v4
        with:
          name: opus-build
          path: ffmpeg-build/

      - name: Download libaom build
        uses: actions/download-artifact@v4
        with:
          name: aom-build
          path: ffmpeg-build/

      - name: Download libvpx build
        uses: actions/download-artifact@v4
        with:
          name: vpx-build
          path: ffmpeg-build/

      - name: Download SVT-AV1 build
        uses: actions/download-artifact@v4
        with:
          name: svtav1-build
          path: ffmpeg-build/

      - name: Download libfdk-aac build
        uses: actions/download-artifact@v4
        with:
          name: fdk-aac-build
          path: ffmpeg-build/

      - name: Download libx265 build
        uses: actions/download-artifact@v4
        with:
          name: x265-build
          path: ffmpeg-build/

      - name: Verify downloaded libraries
        run: |
          echo "=== Downloaded library files ==="
          ls -lah ffmpeg-build/
          echo "=== Library directory ==="
          ls -lah ffmpeg-build/lib/ || true
          echo "=== Include directory ==="
          ls -lah ffmpeg-build/include/ || true
          echo "=== pkg-config files ==="
          ls -lah ffmpeg-build/lib/pkgconfig/ || true
          echo "=== x265.pc content ==="
          cat ffmpeg-build/lib/pkgconfig/x265.pc || echo "x265.pc not found!"
          echo "=== Testing pkg-config for x265 ==="
          export PKG_CONFIG_PATH="$(pwd)/ffmpeg-build/lib/pkgconfig:$PKG_CONFIG_PATH"
          pkg-config --exists x265 && echo "✓ x265 found" || echo "✗ x265 NOT found"
          pkg-config --libs x265 || echo "Failed to get libs"
          pkg-config --cflags x265 || echo "Failed to get cflags"

      - name: Build FFmpeg
        id: build-ffmpeg
        run: |
          chmod +x scripts/build-linux.sh
          ./scripts/build-linux.sh

      - name: Test binary
        id: test-binary
        run: |
          ./ffmpeg-build/bin/ffmpeg -version
          ./ffmpeg-build/bin/ffprobe -version

      - name: Upload FFmpeg artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: |
            ffmpeg-build/bin/ffmpeg
            ffmpeg-build/bin/ffprobe

      - name: Cleanup library artifacts on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "FFmpeg build failed - deleting all library artifacts..."

          # Static artifact names
          ARTIFACTS_TO_DELETE="x264-build opus-build aom-build vpx-build svtav1-build fdk-aac-build x265-build"

          echo "Deleting artifacts: $ARTIFACTS_TO_DELETE"
          DELETED=0
          FAILED=0

          for artifact in $ARTIFACTS_TO_DELETE; do
            echo "Attempting to delete artifact: $artifact"

            # Get artifact ID with error handling
            ARTIFACT_ID=$(gh api "/repos/${{ github.repository }}/actions/artifacts?name=$artifact" 2>/dev/null | jq -r '.artifacts[0].id // empty' 2>/dev/null || echo "")

            if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "null" ]; then
              echo "  Found artifact ID: $ARTIFACT_ID"
              if gh api --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID" 2>/dev/null; then
                echo "  ✓ Successfully deleted: $artifact"
                DELETED=$((DELETED + 1))
              else
                echo "  ✗ Failed to delete: $artifact (API call failed)"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "  ✗ Failed to delete: $artifact (artifact not found or already deleted)"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "Cleanup summary: $DELETED deleted, $FAILED failed"

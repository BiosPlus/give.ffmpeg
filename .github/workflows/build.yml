name: Build FFmpeg

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-x264:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            git

      - name: Get x264 commit hash
        id: setup
        run: |
          echo "Getting x264 latest commit hash..."
          git clone --depth 1 https://code.videolan.org/videolan/x264.git x264-temp
          cd x264-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "x264 commit: $COMMIT_HASH"
          echo "artifact-name=x264-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=x264-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=x264-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf x264-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build x264
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building x264 from source..."
          chmod +x scripts/build-x264-linux.sh
          ./scripts/build-x264-linux.sh

      - name: Upload x264 artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-opus:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            git

      - name: Get libopus commit hash
        id: setup
        run: |
          echo "Getting libopus latest commit hash..."
          git clone --depth 1 https://github.com/xiph/opus.git opus-temp
          cd opus-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "libopus commit: $COMMIT_HASH"
          echo "artifact-name=opus-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=opus-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=opus-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf opus-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build libopus
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building libopus from source..."
          chmod +x scripts/build-opus-linux.sh
          ./scripts/build-opus-linux.sh

      - name: Upload libopus artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-aom:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            git

      - name: Get libaom commit hash
        id: setup
        run: |
          echo "Getting libaom latest commit hash..."
          git clone --depth 1 https://aomedia.googlesource.com/aom aom-temp
          cd aom-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "libaom commit: $COMMIT_HASH"
          echo "artifact-name=aom-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=aom-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=aom-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf aom-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build libaom
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building libaom from source..."
          chmod +x scripts/build-aom-linux.sh
          ./scripts/build-aom-linux.sh

      - name: Upload libaom artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-vpx:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            yasm \
            git

      - name: Get libvpx commit hash
        id: setup
        run: |
          echo "Getting libvpx latest commit hash..."
          git clone --depth 1 https://chromium.googlesource.com/webm/libvpx.git vpx-temp
          cd vpx-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "libvpx commit: $COMMIT_HASH"
          echo "artifact-name=vpx-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=vpx-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=vpx-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf vpx-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build libvpx
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building libvpx from source..."
          chmod +x scripts/build-vpx-linux.sh
          ./scripts/build-vpx-linux.sh

      - name: Upload libvpx artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-svtav1:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            nasm \
            git

      - name: Get SVT-AV1 commit hash
        id: setup
        run: |
          echo "Getting SVT-AV1 latest commit hash..."
          git clone --depth 1 https://gitlab.com/AOMediaCodec/SVT-AV1.git svtav1-temp
          cd svtav1-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "SVT-AV1 commit: $COMMIT_HASH"
          echo "artifact-name=svtav1-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=svtav1-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=svtav1-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf svtav1-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build SVT-AV1
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building SVT-AV1 from source..."
          chmod +x scripts/build-svtav1-linux.sh
          ./scripts/build-svtav1-linux.sh

      - name: Upload SVT-AV1 artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-fdk-aac:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    outputs:
      artifact-name-x86_64: ${{ steps.setup.outputs.artifact-name-x86_64 }}
      artifact-name-arm64: ${{ steps.setup.outputs.artifact-name-arm64 }}
      cache-hit: ${{ steps.check-cache.outputs.hit == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            git

      - name: Get libfdk-aac commit hash
        id: setup
        run: |
          echo "Getting libfdk-aac latest commit hash..."
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git fdk-aac-temp
          cd fdk-aac-temp
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "libfdk-aac commit: $COMMIT_HASH"
          echo "artifact-name=fdk-aac-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "ARTIFACT_NAME=fdk-aac-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "artifact-name-${{ matrix.arch }}=fdk-aac-build-$COMMIT_HASH-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          cd ..
          rm -rf fdk-aac-temp

      - name: Try to download cached artifact
        id: download-cache
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ env.ARTIFACT_NAME }}
          workflow: build.yml
          path: ffmpeg-build/
          search_artifacts: true
          if_no_artifact_found: ignore

      - name: Check if artifact was actually downloaded
        id: check-cache
        run: |
          if [ -d "ffmpeg-build/lib" ] && [ -n "$(ls -A ffmpeg-build/lib 2>/dev/null)" ]; then
            echo "Cache hit - artifact was downloaded"
            echo "hit=true" >> $GITHUB_OUTPUT
          else
            echo "Cache miss - artifact not found"
            echo "hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Build libfdk-aac
        if: steps.check-cache.outputs.hit != 'true'
        run: |
          echo "Cache miss - building libfdk-aac from source..."
          chmod +x scripts/build-fdk-aac-linux.sh
          ./scripts/build-fdk-aac-linux.sh

      - name: Upload libfdk-aac artifact
        if: success() && steps.check-cache.outputs.hit != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ffmpeg-build/
          retention-days: 90

  build-ffmpeg:
    strategy:
      matrix:
        arch: [x86_64, arm64]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    needs: [build-x264, build-opus, build-aom, build-vpx, build-svtav1, build-fdk-aac]
    permissions:
      actions: write  # Required to delete artifacts on failure
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            nasm \
            yasm \
            pkg-config \
            git \
            libssl-dev \
            zlib1g-dev

      - name: Determine library commit hashes
        id: lib-hashes
        run: |
          echo "Getting commit hashes for all libraries..."

          # x264
          git clone --depth 1 https://code.videolan.org/videolan/x264.git x264-temp
          X264_HASH=$(cd x264-temp && git rev-parse HEAD)
          echo "X264_ARTIFACT=x264-build-$X264_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf x264-temp

          # opus
          git clone --depth 1 https://github.com/xiph/opus.git opus-temp
          OPUS_HASH=$(cd opus-temp && git rev-parse HEAD)
          echo "OPUS_ARTIFACT=opus-build-$OPUS_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf opus-temp

          # aom
          git clone --depth 1 https://aomedia.googlesource.com/aom aom-temp
          AOM_HASH=$(cd aom-temp && git rev-parse HEAD)
          echo "AOM_ARTIFACT=aom-build-$AOM_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf aom-temp

          # vpx
          git clone --depth 1 https://chromium.googlesource.com/webm/libvpx.git vpx-temp
          VPX_HASH=$(cd vpx-temp && git rev-parse HEAD)
          echo "VPX_ARTIFACT=vpx-build-$VPX_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf vpx-temp

          # svtav1
          git clone --depth 1 https://gitlab.com/AOMediaCodec/SVT-AV1.git svtav1-temp
          SVTAV1_HASH=$(cd svtav1-temp && git rev-parse HEAD)
          echo "SVTAV1_ARTIFACT=svtav1-build-$SVTAV1_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf svtav1-temp

          # fdk-aac
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git fdk-aac-temp
          FDK_AAC_HASH=$(cd fdk-aac-temp && git rev-parse HEAD)
          echo "FDK_AAC_ARTIFACT=fdk-aac-build-$FDK_AAC_HASH-${{ matrix.arch }}" >> $GITHUB_ENV
          rm -rf fdk-aac-temp

      - name: Download x264 build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.X264_ARTIFACT }}
          path: ffmpeg-build/

      - name: Download libopus build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.OPUS_ARTIFACT }}
          path: ffmpeg-build/

      - name: Download libaom build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.AOM_ARTIFACT }}
          path: ffmpeg-build/

      - name: Download libvpx build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.VPX_ARTIFACT }}
          path: ffmpeg-build/

      - name: Download SVT-AV1 build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SVTAV1_ARTIFACT }}
          path: ffmpeg-build/

      - name: Download libfdk-aac build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.FDK_AAC_ARTIFACT }}
          path: ffmpeg-build/

      - name: Verify downloaded libraries
        run: |
          echo "=== Downloaded library files ==="
          ls -lah ffmpeg-build/
          echo "=== Library directory ==="
          ls -lah ffmpeg-build/lib/ || true
          echo "=== Include directory ==="
          ls -lah ffmpeg-build/include/ || true
          echo "=== pkg-config files ==="
          ls -lah ffmpeg-build/lib/pkgconfig/ || true

      - name: Build FFmpeg
        id: build-ffmpeg
        run: |
          chmod +x scripts/build-linux.sh
          ./scripts/build-linux.sh

      - name: Test binary
        id: test-binary
        run: |
          ./ffmpeg-build/bin/ffmpeg -version
          ./ffmpeg-build/bin/ffprobe -version

      - name: Upload FFmpeg artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-${{ matrix.arch }}
          path: |
            ffmpeg-build/bin/ffmpeg
            ffmpeg-build/bin/ffprobe

      - name: Cleanup library artifacts on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "FFmpeg build failed - deleting all library artifacts to force full rebuild..."

          # Collect all library artifact names for this architecture (regardless of cache status)
          ARTIFACTS_TO_DELETE="${{ env.X264_ARTIFACT }}"
          ARTIFACTS_TO_DELETE="$ARTIFACTS_TO_DELETE ${{ env.OPUS_ARTIFACT }}"
          ARTIFACTS_TO_DELETE="$ARTIFACTS_TO_DELETE ${{ env.AOM_ARTIFACT }}"
          ARTIFACTS_TO_DELETE="$ARTIFACTS_TO_DELETE ${{ env.VPX_ARTIFACT }}"
          ARTIFACTS_TO_DELETE="$ARTIFACTS_TO_DELETE ${{ env.SVTAV1_ARTIFACT }}"
          ARTIFACTS_TO_DELETE="$ARTIFACTS_TO_DELETE ${{ env.FDK_AAC_ARTIFACT }}"

          echo "Deleting artifacts: $ARTIFACTS_TO_DELETE"
          DELETED=0
          FAILED=0

          for artifact in $ARTIFACTS_TO_DELETE; do
            echo "Attempting to delete artifact: $artifact"

            # Get artifact ID with error handling
            ARTIFACT_ID=$(gh api "/repos/${{ github.repository }}/actions/artifacts?name=$artifact" 2>/dev/null | jq -r '.artifacts[0].id // empty' 2>/dev/null || echo "")

            if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "null" ]; then
              echo "  Found artifact ID: $ARTIFACT_ID"
              if gh api --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID" 2>/dev/null; then
                echo "  ✓ Successfully deleted: $artifact"
                DELETED=$((DELETED + 1))
              else
                echo "  ✗ Failed to delete: $artifact (API call failed)"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "  ✗ Failed to delete: $artifact (artifact not found or already deleted)"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "Cleanup summary: $DELETED deleted, $FAILED failed"
